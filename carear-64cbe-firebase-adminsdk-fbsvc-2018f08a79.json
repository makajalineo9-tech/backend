require('dotenv').config();
const express = require('express');
const admin = require('firebase-admin');
const cors = require('cors');
const nodemailer = require('nodemailer');

// ---------------------------
// ðŸ”¹ Firebase Admin Initialization
// ---------------------------
const serviceAccount = require(process.env.FIREBASE_SERVICE_ACCOUNT);

admin.initializeApp({
  credential: admin.credential.cert(serviceAccount),
});

const db = admin.firestore();
const app = express();

// ---------------------------
// ðŸ”¹ Nodemailer Setup with Gmail
// ---------------------------
const transporter = nodemailer.createTransport({
  service: 'gmail',
  auth: {
    user: process.env.EMAIL_USER,
    pass: process.env.EMAIL_PASS,
  },
});

// Verify Nodemailer connection on startup
transporter.verify((error, success) => {
  if (error) {
    console.log(' Nodemailer configuration error:', error);
    console.log('Tips:');
    console.log('1. Make sure you enabled 2FA on your Gmail');
    console.log('2. Use App Password (16 characters) not your regular password');
  } else {
    console.log(' Nodemailer is ready to send emails');
    console.log(` Using: ${process.env.EMAIL_USER}`);
  }
});

// ---------------------------
// ðŸ”¹ Middleware
// ---------------------------
app.use(cors());
app.use(express.json());

// ---------------------------
// ðŸ”¹ Helper Functions
// ---------------------------

// Send verification email
const sendVerificationEmail = async (email, verificationLink, fullName, role) => {
  const roleDisplay = {
    student: 'Student',
    institute: 'Institution',
    company: 'Company'
  }[role] || role;

  const emailTemplate = `
    <!DOCTYPE html>
    <html>
    <head>
      <meta charset="utf-8">
      <style>
        body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; margin: 0; padding: 0; }
        .container { max-width: 600px; margin: 0 auto; background: #ffffff; }
        .header { background: #000000; color: white; padding: 30px 20px; text-align: center; }
        .content { padding: 30px; background: #f9f9f9; }
        .button { 
          background: #000000; 
          color: white; 
          padding: 14px 35px; 
          text-decoration: none; 
          border-radius: 8px; 
          display: inline-block;
          font-weight: bold;
          font-size: 16px;
          margin: 20px 0;
        }
        .footer { 
          text-align: center; 
          padding: 20px; 
          color: #666; 
          font-size: 14px;
          background: #fff;
          border-top: 1px solid #eee;
        }
        .link-box { 
          background: #eeeeee; 
          padding: 15px; 
          border-radius: 6px; 
          word-break: break-all;
          margin: 20px 0;
          font-size: 14px;
        }
      </style>
    </head>
    <body>
      <div class="container">
        <div class="header">
          <h1>CareerGuide LESOTHO</h1>
          <p>Email Verification Required</p>
        </div>
        <div class="content">
          <h2>Welcome to CareerGuide, ${fullName}!</h2>
          <p>You've successfully registered as a <strong>${roleDisplay}</strong> account.</p>
          <p>To activate your account and start using CareerGuide, please verify your email address by clicking the button below:</p>
          
          <div style="text-align: center;">
            <a href="${verificationLink}" class="button">Verify Email Address</a>
          </div>
          
          <p>Or copy and paste this link into your browser:</p>
          <div class="link-box">${verificationLink}</div>
          
          <p><strong>Important:</strong> This verification link will expire in 24 hours.</p>
          <p>If you didn't create this account, please ignore this email.</p>
        </div>
        <div class="footer">
          <p>&copy; ${new Date().getFullYear()} CareerGuide LESOTHO. All rights reserved.</p>
          <p>Building the future of career development in Lesotho</p>
        </div>
      </div>
    </body>
    </html>
  `;

  const mailOptions = {
    from: {
      name: 'CareerGuide LESOTHO',
      address: process.env.EMAIL_USER
    },
    to: email,
    subject: 'Verify Your Email - CareerGuide LESOTHO',
    html: emailTemplate,
    text: `
Welcome to CareerGuide LESOTHO!

Hello ${fullName},

You've registered as a ${roleDisplay} account. To complete your registration, please verify your email address by clicking the link below:

${verificationLink}

This link will expire in 24 hours.

If you didn't create this account, please ignore this email.

Best regards,
CareerGuide LESOTHO Team
    `.trim()
  };

  try {
    const info = await transporter.sendMail(mailOptions);
    console.log(`Verification email sent to ${email}`);
    console.log(`   Message ID: ${info.messageId}`);
    return { success: true, messageId: info.messageId };
  } catch (error) {
    console.error(` Failed to send verification email to ${email}:`, error);
    return { success: false, error: error.message };
  }
};

// Error handler
const handleError = (error, res) => {
  console.error('Server Error:', error);
  
  // Firebase Auth Errors
  if (error.code === 'auth/email-already-exists') {
    return res.status(400).json({ error: 'This email is already registered. Please use a different email or try logging in.' });
  }
  if (error.code === 'auth/invalid-email') {
    return res.status(400).json({ error: 'The email address is invalid. Please check and try again.' });
  }
  if (error.code === 'auth/weak-password') {
    return res.status(400).json({ error: 'Password should be at least 6 characters long.' });
  }
  
  const message = error.message || 'An unexpected error occurred. Please try again.';
  res.status(500).json({ error: message });
};

// ---------------------------
// ðŸ”¹ Routes
// ---------------------------

// Health check
app.get('/', (req, res) => {
  res.json({ 
    message: 'Career Guidance Backend is running',
    status: 'healthy',
    timestamp: new Date().toISOString(),
    services: {
      firebase: 'connected',
      firestore: 'connected',
      email: process.env.EMAIL_USER ? 'configured' : 'not configured'
    }
  });
});

// Register user
app.post('/register', async (req, res) => {
  const { email, password, fullName, role, phone, institutionName } = req.body;

  // Validation
  if (!email || !password || !fullName || !role) {
    return res.status(400).json({ error: 'All fields are required: email, password, full name, and role' });
  }

  if (password.length < 6) {
    return res.status(400).json({ error: 'Password must be at least 6 characters long' });
  }

  try {
    console.log(` Starting registration for: ${email} as ${role}`);

    // 1. Create user in Firebase Auth
    const userRecord = await admin.auth().createUser({
      email,
      password,
      displayName: fullName,
      phoneNumber: phone || null,
      emailVerified: false,
    });

    console.log(`Firebase user created: ${userRecord.uid}`);

    // 2. Save user data in Firestore
    const userData = {
      email,
      fullName,
      role,
      phone: phone || '',
      institutionName: institutionName || '',
      createdAt: admin.firestore.FieldValue.serverTimestamp(),
      emailVerified: false,
    };

    await db.collection('users').doc(userRecord.uid).set(userData);
    console.log(` User data saved to Firestore`);

    // 3. Generate email verification link
    const actionCodeSettings = {
      url: `${process.env.FRONTEND_URL}/verify-email?email=${encodeURIComponent(email)}&role=${role}`,
      handleCodeInApp: true,
    };

    const verificationLink = await admin.auth().generateEmailVerificationLink(email, actionCodeSettings);
    console.log(`Verification link generated`);

    // 4. Send verification email
    const emailResult = await sendVerificationEmail(email, verificationLink, fullName, role);

    const responseData = {
      message: 'Account created successfully! Please check your email for the verification link.',
      uid: userRecord.uid,
      role,
      emailSent: emailResult.success,
    };

    // Include verification link in development for testing
    if (process.env.NODE_ENV === 'development') {
      responseData.verificationLink = verificationLink;
      console.log(`Development verification link: ${verificationLink}`);
    }

    if (!emailResult.success) {
      console.log('Registration completed but email failed to send');
      responseData.message = 'Account created but verification email failed to send. Please contact support.';
      responseData.note = 'Email service temporarily unavailable';
    }

    res.status(201).json(responseData);

  } catch (error) {
    console.error(' Registration failed:', error);
    handleError(error, res);
  }
});

app.post('/check-verification', async (req, res) => {
  try {
    const { email, uid } = req.body;

    if (!email && !uid) {
      return res.status(400).json({ error: 'Provide either email or uid' });
    }

    let userRecord;
    if (uid) {
      userRecord = await admin.auth().getUser(uid);
    } else {
      userRecord = await admin.auth().getUserByEmail(email);
    }

    const verified = !!userRecord.emailVerified;

    return res.json({ verified });
  } catch (error) {
    console.error('check-verification error:', error);

    // If user not found, respond with verified: false (but 404 is also appropriate)
    if (error.code === 'auth/user-not-found') {
      return res.status(404).json({ error: 'User not found', verified: false });
    }

    return res.status(500).json({ error: error.message || 'Internal server error' });
  }
});

// Login user
app.post('/login', async (req, res) => {
  const { email, password } = req.body;

  if (!email || !password) {
    return res.status(400).json({ error: 'Email and password are required' });
  }

  try {
    // 1. Authenticate with Firebase REST API
    const firebaseVerifyUrl = `https://identitytoolkit.googleapis.com/v1/accounts:signInWithPassword?key=${process.env.FIREBASE_API_KEY}`;
    const response = await fetch(firebaseVerifyUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, password, returnSecureToken: true }),
    });
    
    const authData = await response.json();

    if (authData.error) {
      const errorMsg = authData.error.message === 'INVALID_LOGIN_CREDENTIALS' 
        ? 'Invalid email or password' 
        : authData.error.message;
      return res.status(401).json({ error: errorMsg });
    }

    const { localId: uid, idToken } = authData;

    // 2. Get accurate email verification status from Firebase Admin SDK
    const adminUser = await admin.auth().getUser(uid);
    const emailVerified = adminUser.emailVerified;

    // 3. Get user data from Firestore
    const userDoc = await db.collection('users').doc(uid).get();
    
    if (!userDoc.exists) {
      return res.status(404).json({ error: 'User not found in database' });
    }

    const userData = userDoc.data();

    // 4. Sync Firestore with actual Firebase Auth status
    if (emailVerified && !userData.emailVerified) {
      await db.collection('users').doc(uid).update({
        emailVerified: true,
        emailVerifiedAt: admin.firestore.FieldValue.serverTimestamp()
      });
    }

    // 5. Check email verification using Admin SDK status (accurate)
    if (!emailVerified) {
      return res.status(403).json({ 
        error: 'Please verify your email before logging in. Check your inbox for the verification link.' 
      });
    }

    // 6. Login successful
    res.json({
      message: 'Login successful!',
      uid,
      role: userData.role,
      token: idToken,
      user: {
        email: userData.email,
        fullName: userData.fullName,
        phone: userData.phone,
        institutionName: userData.institutionName,
        emailVerified: true,
      },
    });

  } catch (error) {
    console.error('Login error:', error);
    res.status(401).json({ error: 'Login failed. Please check your credentials.' });
  }
});


// Resend verification email endpoint
app.post('/resend-verification', async (req, res) => {
  const { email, role } = req.body;

  if (!email) {
    return res.status(400).json({ error: 'Email is required' });
  }

  try {
    console.log(`Resending verification email to: ${email}`);
    
    // Get user from Firebase Auth
    const user = await admin.auth().getUserByEmail(email);
    
    // Generate new verification link
    const actionCodeSettings = {
      url: `${process.env.FRONTEND_URL}/verify-email?email=${encodeURIComponent(email)}&role=${role || 'student'}`,
      handleCodeInApp: true,
    };

    const verificationLink = await admin.auth().generateEmailVerificationLink(email, actionCodeSettings);
    
    // Send email using your existing sendVerificationEmail function
    const emailResult = await sendVerificationEmail(email, verificationLink, user.displayName || 'User', role || 'student');

    if (emailResult.success) {
      res.json({
        message: 'Verification email sent successfully',
        emailSent: true,
      });
    } else {
      throw new Error(emailResult.error || 'Failed to send email');
    }

  } catch (error) {
    console.error('Resend verification error:', error);
    
    if (error.code === 'auth/user-not-found') {
      return res.status(404).json({ error: 'User not found' });
    }
    
    res.status(500).json({ error: 'Failed to resend verification email' });
  }
});

// app.get('/debug-user/:email', async (req, res) => {
//   try {
//     const email = req.params.email;
    
//     // Check Firebase Auth via Admin SDK
//     const user = await admin.auth().getUserByEmail(email);
    
//     // Check Firestore
//     const userDoc = await db.collection('users').doc(user.uid).get();
//     const userData = userDoc.data();

//     res.json({
//       email,
//       firebaseAuth: {
//         emailVerified: user.emailVerified,
//         uid: user.uid,
//         displayName: user.displayName,
//         metadata: user.metadata
//       },
//       firestore: userData,
//       status: user.emailVerified ? 'VERIFIED' : 'NOT_VERIFIED'
//     });
//   } catch (error) {
//     res.status(500).json({ error: error.message });
//   }
// });
// Add this temporary fix endpoint
// app.post('/manual-fix-user', async (req, res) => {
//   try {
//     const email = "jaherel942@ametitas.com";
    
//     // Get user from Firebase Auth
//     const user = await admin.auth().getUserByEmail(email);
//     console.log(` Firebase Auth status for ${email}:`, {
//       emailVerified: user.emailVerified,
//       uid: user.uid
//     });

//     // Update Firestore
//     await db.collection('users').doc(user.uid).update({
//       emailVerified: true,
//       emailVerifiedAt: admin.firestore.FieldValue.serverTimestamp()
//     });

//     console.log(` Manually updated Firestore for ${email}`);

//     // Verify the update
//     const updatedDoc = await db.collection('users').doc(user.uid).get();
//     console.log(`Firestore after update:`, updatedDoc.data());

//     res.json({ 
//       message: 'User manually fixed',
//       email: user.email,
//       firebaseEmailVerified: user.emailVerified,
//       firestoreEmailVerified: updatedDoc.data().emailVerified
//     });
//   } catch (error) {
//     console.error('Manual fix error:', error);
//     res.status(500).json({ error: error.message });
//   }
// });


// Get user profile
app.get('/users/:uid', async (req, res) => {
  const { uid } = req.params;

  try {
    const doc = await db.collection('users').doc(uid).get();
    
    if (!doc.exists) {
      return res.status(404).json({ error: 'User not found' });
    }

    res.json({ 
      uid: doc.id, 
      ...doc.data() 
    });

  } catch (error) {
    handleError(error, res);
  }
});

// Update user profile
app.put('/users/:uid', async (req, res) => {
  const { uid } = req.params;
  const updateData = req.body;

  try {
    await db.collection('users').doc(uid).update({
      ...updateData,
      updatedAt: admin.firestore.FieldValue.serverTimestamp(),
    });

    res.json({ 
      message: 'User updated successfully',
      uid 
    });

  } catch (error) {
    handleError(error, res);
  }
});

// Get all users (admin only)
app.get('/users', async (req, res) => {
  try {
    const snapshot = await db.collection('users').get();
    const users = snapshot.docs.map(doc => ({ 
      uid: doc.id, 
      ...doc.data() 
    }));
    
    res.json(users);
  } catch (error) {
    handleError(error, res);
  }
});

// ---------------------------
//  Server Start
// ---------------------------
const PORT = process.env.PORT || 5000;

app.listen(PORT, () => {
  console.log('\nCareerGuide Backend Server');
  console.log('==============================');
  console.log(` Port: ${PORT}`);
  console.log(` Email: ${process.env.EMAIL_USER}`);
  console.log(`Frontend: ${process.env.FRONTEND_URL}`);
  console.log(`Firebase: ${serviceAccount.project_id}`);
  console.log('==============================\n');
});